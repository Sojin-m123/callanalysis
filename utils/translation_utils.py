from deep_translator import GoogleTranslator
from transformers import pipeline

# Fallback model cache
translator_pipeline = None  # Global cache for NLLB model

# Optional: device setup (CUDA if available)
import torch
device = 0 if torch.cuda.is_available() else -1

malayalam_reverse_map = {
            'ആശയവുമില്ല': 'ഐഡിയയുമില്ല',
            'എന്ന് ': 'നിന്നും ',
            'ചെയ്യാൻ': 'ചെയ്യാവോ',
            'പരിഹാരങ്ങളും': 'സൊല്യൂഷൻസ്',
            'പരിശീലനാർത്ഥി': 'ട്രെയിനീ',
            'തീരുമാനം': 'ഡിസിഷൻ',
            'ഉദ്യോഗം': 'ജോബ്',
            'പദ്ധതി': 'പ്രൊജക്ട്',
            'സമസ്യ': 'പ്രോബ്ലം',
            'സഹായം': 'ഹെൽപ്പ്',
            'ഉദാഹരണം': 'എക്സാംപിൾ',
            'വിവരണം': 'ഡിസ്‌ക്രിപ്ഷൻ',
            'വിലയിരുത്തൽ': 'ഇവാലുവേഷൻ',
            'പരീക്ഷണം': 'ടെസ്റ്റ്',
            'പരീക്ഷ': 'എക്സാം',
            'പഠനം': 'സ്റ്റഡി',
            'വിദ്യാർത്ഥി': 'സ്റ്റുഡന്റ്',
            'വ്യാപാരം': 'ബിസിനസ്',
            'തൊഴിലാളി': 'എംപ്ലോയി',
            'ഉദ്യോഗസ്ഥൻ': 'സ്റ്റാഫ്',
            'കൂടിയാലോചന': 'മീറ്റിംഗ്',
            'ആരംഭം': 'സ്റ്റാർട്ട്',
            'അവസാനം': 'എൻഡ്',
            'സംശയം': 'ഡൗട്ട്',
            'പിന്തുണ': 'സപ്പോർട്ട്',
            'ആശ്വാസം': 'റിലീഫ്',
            'താല്പര്യം': 'ഇന്ററസ്റ്റ്',
            'പ്രതിഫലം': 'റിവാർഡ്',
            'പരിശോധന': 'ചെക്ക്',
            'ഉപകരണങ്ങൾ': 'ടൂൾസ്',
            'തെളിവ്': 'പ്രൂഫ്',
            'അനുമതി': 'പർമിഷൻ',
            'ലക്ഷ്യം': 'ഗോൾ',
            'വൈഭവം': 'ഗ്ലാമർ',
            'സംരക്ഷണം': 'സെക്യൂരിറ്റി',
            'നയം': 'പോളിസി',
            'പരിധി': 'ലിമിറ്റ്',
            'പരീക്ഷണഘട്ടം': 'പൈലറ്റ്',
            'സവിശേഷത': 'ഫീച്ചർ',
            'തികഞ്ഞത്': 'ഓപ്റ്റിമൽ',
            'മാറ്റം': 'ചേഞ്ച്',
            'ഉപഭോക്താവ്': 'യൂസർ',
            'പ്രകടനം': 'പെർഫോമൻസ്',
            'വിശ്വാസം': 'ട്രസ്റ്റ്',
            'വൈഭവം': 'ഗ്രാൻഡർ',
            'വിഫലം': 'ഫെയിൽഡ്',
            'വിജയം': 'സക്സസ്',
            'നിര്‍ണ്ണയം': 'ജഡ്ജ്മെന്റ്',
            'പ്രതീക്ഷ': 'എക്‌സ്‌പെക്ടേഷൻ',
            'അവസരം': 'ഓപ്പർച്യൂണിറ്റി',
            'തീരുവിൽ': 'ഫൈനലായി',
            'കണ്ണോട്ട്': 'ഫോക്കസ്',
            'തെളിവാക്കുക': 'വെരിഫൈ ചെയ്യുക',
            'മാറ്റിവെക്കുക': 'റീഷെഡ്യൂൾ ചെയ്യുക',
            'നൽകുക': 'പ്രൊവൈഡ് ചെയ്യുക',
            'പരിഷ്കരണം': 'അപ്പ്‌ഡേറ്റ്',
            'തിരഞ്ഞെടുത്തത്': 'സെലെക്ട് ചെയ്തത്',
            'തിരഞ്ഞെടുപ്പ്': 'ഓപ്ഷൻ',
            'സ്ഥിരീകരണം': 'കോൺഫർമേഷൻ',
            'ചിട്ട': 'പ്ലാൻ',
            'പരാമർശം': 'റഫറൻസ്',
            'മാറ്റം': 'മോഡിഫിക്കേഷൻ',
            'അഭിപ്രായം': 'ഫീഡ്‌ബാക്ക്',
            'കാഴ്ചപ്പാട്': 'വ്യൂ',
            'പിന്തുടരുക': 'ഫോളോ ചെയ്യുക',
            'ഭരണസംവിധാനം': 'മാനേജ്മെന്റ്',
            'അനുഭവം': 'എക്സ്പീരിയൻസ്',
            'ഉണ്ടോ': 'വേണോ',
            'തന്ത്രശാസ്ത്ര സ്ഥാപനം': 'ഐടി ഫിർം',
            'നയം': 'പോളിസി',
            'പരിഗണന': 'കൺസിഡറേഷൻ',
            'നിബന്ധനകൾ': 'ടേംസ്',
            'സമിതി': 'കമ്മിറ്റി',
            'നിക്ഷേപം': 'ഇൻവെസ്റ്റ്‌മെന്റ്',
            'സംരംഭം': 'സ്റ്റാർട്ടപ്പ്',
            'തൊഴിൽ': 'ജോബ്',
            'പരിശീലനം': 'ട്രെയിനിംഗ്',
            'വായ്പ': 'ലോൺ',
            'തരംഗം': 'ട്രെൻഡ്',
            'നിക്ഷേപകന്‍': 'ഇൻവെസ്റ്റർ',
            'പദ്ധതി': 'പ്രൊജക്ട്',
            'അവകാശം': 'റൈറ്റ്‌സ്',
            'സുരക്ഷ': 'സെക്യൂരിറ്റി',
            'അനുമതി': 'പരമിഷൻ',
            'നയതന്ത്രം': 'ഡിപ്ലോമസി',
            'വിനിമയം': 'ട്രാൻസാക്ഷൻ',
            'പരിഹാരങ്ങളും': 'സൊല്യൂഷൻസ്',
            'മീൻ/മെൻ ടെക്‌നോളജി പ്ലാറ്റ്ഫോം': 'മീൻ ആൻഡ് മെൻ സ്റ്റാക്ക്',
            'ആവശ്യ പ്രയോഗ നിർമ്മാണം': 'ആപ്ലിക്കേഷൻ ഡെവലപ്മെന്റ്',
            'അനുഭവ സർട്ടിഫിക്കറ്റ്': 'എക്സ്പീരിയൻസ് സർട്ടിഫിക്കറ്റ്',
            'തിരഞ്ഞെടുത്ത പ്രക്രിയ': 'സ്ക്രീനിംഗ് പ്രോസസ്സ്',
            'ഇന്റർനെറ്റ് സുരക്ഷാ': 'സൈബർ സെക്യൂരിറ്റി',
            'ഡാറ്റാ ശാസ്ത്രം': 'ഡേറ്റ സയൻസ്',
            'ജീവന്ത പദ്ധതികൾ': 'ലൈവ് പ്രൊജക്ട്സ്',
            'ജീവന്ത പരിശീലനം': 'ലൈവ് ട്രെയിനിംഗ്',
            'പണമേറ്റ് പരിശീലനം': 'പെയ്ഡ് ഇന്റേൺഷിപ്പ്',
            'സുരക്ഷാ പരിഹാരങ്ങൾ': 'സെക്യൂരിറ്റി സൊല്യൂഷൻസ്',
            'പൂർത്തീകരണ സർട്ടിഫിക്കറ്റ്': 'സർട്ടിഫിക്കറ്റ് ഓഫ് കമ്പ്ലീഷൻ',
            'കൂടുതൽ വിവരം': 'മോർ ഇൻഫർമേഷൻ',
            'അവശ്യമില്ല': 'നോ നീഡ്',
            'സാധ്യമല്ല': 'നോട്ട് പൊസിബിൾ',
            'അറിയിപ്പ് ലഭിച്ചു': 'നോട്ടിഫിക്കേഷൻ റിസീവ്ഡ്',
            'ആറായിരം': 'സിക്സ് തൗസൻഡ്',
            'സോഫ്റ്റ്വെയറിൽ': 'സോഫ്റ്റ്‌വെയർ',
            'പരിഹാരങ്ങൾ': 'സൊല്യൂഷൻസ്',
            'പരിഹാരം': 'സൊല്യൂഷൻ',
            'മൃദുസ്ഥിതി പ്രയോഗം': 'സോഫ്റ്റ്‌വെയർ',
            'പരിശീലനം': 'ഇന്റേൺഷിപ്പ്',
            'സാക്ഷ്യപത്രം': 'സർട്ടിഫിക്കറ്റ്',
            'അടിസ്ഥാനഘടന': 'ഫ്രെയിംവർക്ക്',
            'ചോദ്യോത്തരസമരം': 'ഇന്റർവ്യൂ',
            'തൊഴിൽനിയമനം': 'പ്ലേസ്മെന്റ്',
            'ഭരണസംവിധാനം': 'മാനേജ്മെന്റ്',
            'അനുഭവം': 'എക്സ്പീരിയൻസ്',
            'ഉണ്ടോ': 'വേണോ',
            'തന്ത്രശാസ്ത്ര സ്ഥാപനം': 'ഐടി ഫിർം',
            'പരിഹാരവുമായി': 'സൊലൂഷൻസ്',
            'വാട്ട്‌സാപ്പ്': 'വാട്ട്‌സാപ്പ്',
            'സുരക്ഷാ': 'സെക്യൂരിറ്റി',
            'സ്ഥാപനം': 'കമ്പനി',
            'പദ്ധതി': 'പ്രൊജക്ട്',
            'ബന്ധപ്പെടുന്നു': 'വിളിക്കുന്നു',
            'ഗൂഗിൾ': 'ഗൂഗിൾ',
            'പരിഹാരവും': 'സൊലൂഷൻസ്',
            'കൃത്രിമ ബുദ്ധിമത്താ': 'എഐ',
            'മെഷീൻ ലേണിംഗ്': 'എംഎൽ',
            'മാനവ വിഭവശേഷി': 'എച് ആർ',
            'യോഗ്യത': 'ക്വാളിഫിക്കേഷൻ',
            'നികുതി': 'ഫീ',
            'വിശദാംശങ്ങൾ': 'ഡീറ്റെയിൽസ്',
            'പ്രചാരണ പത്രിക': 'ബ്രോഷർ',
            'അവകാശമാണോ?': 'ആണോ',
            'വിവരങ്ങൾ': 'ഡീറ്റെയിൽസ്',
            'അന്വേഷണം': 'ഇൻക്വയറി',
            'തിരയുന്നു': 'നോക്കിയിരുന്നു',
            'പങ്കിടാൻ': 'ഷെയർ',
            'പരിഹാരങ്ങളിൽ': 'സൊല്യൂഷൻസ്', 
            'വിശദാംശങ്ങളും': 'ഡീറ്റെയിൽസ്',
            'അവസരങ്ങൾ': 'ഓപ്പർച്യൂണിറ്റീസ്',
            'സാങ്കേതികവിദ്യ': 'ടെക്‌നോളജി',
            'സാങ്കേതികവിദ്യകൾ': 'ടെക്‌നോളജീസ്',
            'സാങ്കേതികവിദ്യയുടെ': 'ടെക്‌നോളജിയുടെ',
            'സാങ്കേതികവിദ്യകൾക്ക്': 'ടെക്‌നോളജികൾക്ക്',
            'ശരി': 'ഓക്കെ ',
            'ഇന്റർവ്യൂ': 'ഇന്റർവ്യൂ',
            'പരിശീലനം': 'ട്രെയിനിംഗ്',
            'പരിശീലനത്തിനായി': 'ട്രെയിനിംഗിനായി',
            'സുപ്രഭാതം': 'ഗുഡ്മോറ്നിംഗ്',
            'തിരയുകയാണോ': 'നോക്കുകയാണോ ',
            'തിരയുന്നത്': 'നോക്കുന്നത്',
            'പങ്കിടുക': 'ഷെയർ ചെയ്യുക',
            'പങ്കിടുന്നു': 'ഷെയർ ചെയ്യുന്നു',
            'പങ്കിടാൻ': 'ഷെയർ ചെയ്യാൻ',
            'കിഴിവ് ': 'ഡിസ്‌കൗണ്ട്',
            'മൊബൈൽ വികസനത്തിനായി': 'മൊബൈൽ ഡെവലപ്മെന്റിനായി',
            'പ്രവർത്തിക്കുന്നു': 'വർക്കിംഗ്',
            'പ്രവർത്തിക്കാൻ': 'വർക്കിംഗ്',
            'പങ്കിടട്ടെ': 'ഷെയർ ചെയ്യട്ടെ',
            'പരിശീലനത്തെയും': 'ട്രെയിനിംഗിനെയും',
            'തിരയുകയാണ്.    ': 'നോക്കുകയാണ്.',
            'വികസനത്തിനായി':'ഡെവലൊപ്മെന്റിനായി ',
            'ഭൗതികശാസ്ത്രം': 'ഫിസിക്സ്',
            'പരിശീലന സർട്ടിഫിക്കേഷനാണ്': 'ട്രെയിനിംഗ് സർട്ടിഫിക്കേഷൻ',
            'അതെ':'യെസ് ',
            'ഉച്ചതിരിഞ്ഞ് ':'ഗുഡ് അഫ്റെർൂൺ  '


        }
    

def translate_to_malayalam(text_or_dict):
    global translator_pipeline  # To modify the global cached translator

    try:
        text = text_or_dict.get('raw_transcription', '') if isinstance(text_or_dict, dict) else text_or_dict
        if not text.strip():
            raise ValueError("No text found for translation")

        print("🔤 Translating to Malayalam using Google Translator...")
        try:
            ml_text = GoogleTranslator(source='en', target='ml').translate(text)
        except Exception as google_error:
            print(f"⚠️ Google Translator failed: {str(google_error)}. Falling back to NLLB...")

            if translator_pipeline is None:
                try:
                    translator_pipeline = pipeline(
                        "translation",
                        model="facebook/nllb-200-distilled-600M",
                        src_lang="eng_Latn",
                        tgt_lang="mal_Mlym",
                        device=device
                    )
                    print(f"✅ NLLB pipeline loaded on device: {'CUDA' if device == 0 else 'CPU'}")
                except Exception as e:
                    print(f"❌ Failed to load NLLB model: {str(e)}")
                    raise

            ml_text = translator_pipeline(text, max_length=512)[0]['translation_text']

        # Word replacements
        for original, replacement in malayalam_reverse_map.items():
            ml_text = ml_text.replace(original, replacement)

        # Return updated dict or string
        if isinstance(text_or_dict, dict):
            text_or_dict['translated_malayalam'] = ml_text
            return text_or_dict
        return ml_text

    except Exception as e:
        print(f"❌ Translation error: {str(e)}")
        return text_or_dict